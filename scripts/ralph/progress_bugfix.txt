# Bugfix PRD Progress Tracker
# PRD: necromancer_bugfix_prd.json
# Created: 2026-01-08
# Version: Alpha 0.3.1-bugfix

## Key Files

### Smithing System (cmd4.c)
- src/cmd4.c:6001 - reforge_menu()
- src/cmd4.c:6145 - reclaim_menu()
- src/cmd4.c:6281 - masterwork_menu()
- src/cmd4.c:5952 - pick_random_artifact(tval_list, best)
- src/cmd4.c:3872 - pay_costs() - XP/turn deduction
- src/cmd4.c:6692 - do_cmd_smithing_screen() - main entry

### Sauron's Lair (generate.c)
- src/generate.c:3831-3894 - throne_gen()
- src/generate.c:4068 - SAURON_DEPTH trigger
- lib/edit/vault.txt:1295-1331 - N:450 "Sauron's Throne Room"
- src/defines.h:185 - #define SAURON_DEPTH 20

### Escape Logic (cmd2.c, files.c)
- src/cmd2.c:105-307 - do_cmd_go_up()
- src/files.c:3187-3257 - do_cmd_escape()
- src/files.c:4041-4078 - has_ring_of_thrain(), can_escape_dol_guldur()

### Starting Equipment (birth.c)
- src/birth.c:594-669 - Starting equipment loop
- lib/edit/race.txt - Race definitions with start_items

### Artifact Data
- lib/edit/artefact.txt - Artifact definitions

## Bug Analysis

### BUG-001: Masterwork ordered list
- Location: src/cmd4.c:5952 pick_random_artifact()
- Issue: When best=TRUE, iterates from artifact 0 upward, returns first match
- Fix: Need to collect all valid artifacts first, then pick highest level

### BUG-002: Smithing XP/turn consumption
- Location: src/cmd4.c:3872 pay_costs()
- Note: pay_costs() exists but may not be called from Reforge/Reclaim/Masterwork
- Need to verify call chain

### BUG-003: Sauron's lair escape glitch
- Location: src/generate.c:3831 throne_gen()
- Issue: Staircase search may fail, player placed at (0,0)
- Fix: Ensure staircase is found or create fallback

### BUG-004: Reforge shield â†’ hammer
- Location: src/cmd4.c:5900 pick_random_sval()
- Issue: Incorrect tval/sval mapping for shields

### BUG-005/006: Add type selection to Reclaim/Masterwork
- Location: src/cmd4.c:6145 reclaim_menu(), 6281 masterwork_menu()
- Note: reforge_menu() already has type selection UI

### BUG-007: Double forge in vaults
- Location: lib/edit/vault.txt - check for duplicate '0' placements
- Also: src/generate.c forge placement logic

## Task Progress

| Task | Status | Commit |
|------|--------|--------|
| PREP-001 | COMPLETE | - |
| BUG-001 | COMPLETE | 58c440a |
| BUG-002 | COMPLETE | 0d2c2ad |
| BUG-003 | COMPLETE | ccb01bb |
| BUG-004 | COMPLETE | 248be25 |
| BUG-005 | COMPLETE | f6ed065 |
| BUG-006 | COMPLETE | adbe4b1 |
| BUG-007 | COMPLETE | 94e0720 |
| TYPO-001 | COMPLETE | f77d77b |
| TYPO-002 | COMPLETE | 51a4f0a |
| FEAT-001 | COMPLETE | efe4804 |
| BALANCE-001 | COMPLETE | 1608dff |
| FINAL-001 | COMPLETE | 24a88ee |

## PRD EXECUTION COMPLETE - 2026-01-08
All 13 tasks finished. Release notes: docs/BUGFIX_NOTES_0.3.1.md
