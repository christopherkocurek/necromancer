# The Necromancer - Alpha 0.3.1 Bugfix Release Notes

**Release Date**: 2026-01-08
**PRD**: necromancer_bugfix_prd.json

---

## Critical Bug Fixes

### BUG-001: Masterwork Ordered List Bug
**Commit**: 58c440a

Masterwork was selecting artifacts in a fixed order (always Isildur's Longsword first, Ringil second, etc.) instead of randomly. The `pick_random_artifact()` function now:
- Collects all available artifacts matching the category
- Identifies the highest artifact level among candidates
- Randomly selects from all artifacts at that highest level

### BUG-002: Smithing XP/Turn Consumption
**Commit**: 0d2c2ad

Reforge, Reclaim, and Masterwork were not consuming XP or game turns. Added:
- **Reforge**: 500 XP cost + 1 turn
- **Reclaim**: Artifact level x 50 XP cost + 1 turn
- **Masterwork**: Artifact level x 100 XP cost (premium) + 1 turn

### BUG-003: Sauron's Lair Escape Glitch
**Commit**: ccb01bb

Entering Sauron's throne room could spawn the player at (0,0), a wall position. Moving from there triggered an out-of-bounds check that called `do_cmd_escape()`, ending the game with "escaped empty-handed".

Fixed by:
- Removing restrictive x-coordinate range (30-45) from staircase search
- Searching entire map for any FEAT_LESS staircase
- Adding fallback to create a staircase if none found

---

## Gameplay Bug Fixes

### BUG-004: Reforge Shield to Hammer Bug
**Commit**: 248be25

The Reforge menu used 'h' for both hafted weapons and shields, causing shield selection to produce hammers. Changed shield key from 'h' to 'i' (sh**i**eld).

### BUG-005: Add Type Selection to Reclaim
**Commit**: f6ed065

Reclaim was pure RNG across all artifact types within a category. Added submenu:
- Weapons: (s)word, (p)olearm, (h)afted, (b)ow, (a)ny
- Armor: (m)ail, (l)ight, sh(i)eld, hel(M), (c)loak, (g)loves, boo(t)s, (a)ny
- Jewelry: (r)ing, a(m)ulet, (a)ny

### BUG-006: Add Type Selection to Masterwork
**Commit**: adbe4b1

Same type selection UI as Reclaim applied to Masterwork.

### BUG-007: Double Forge in Vaults
**Commit**: 94e0720

Two vaults had multiple forge placements:
- **Scout Camp** (N:17): Reduced from 2 forges to 1
- **Orc Forge** (N:32): Reduced from 3 forges to 1

---

## Typo Fixes

### TYPO-001: Missing Accents in Tolkien Names
**Commit**: f77d77b

Fixed:
- `Lothlorien` -> `Lothlórien`
- `Dunedain` -> `Dúnedain`

Affected files: artefact.txt, object.txt

### TYPO-002: Voice to Spirit Rename
**Commit**: 51a4f0a

Changed all UI display strings from "Voice" to "Spirit" for thematic consistency:
- Character sheet display
- Main status bar ("Voice" -> "Spirit", "Vce" -> "Spi")

---

## New Features

### FEAT-001: Istari Starting Equipment
**Commit**: efe4804

Istari playtest race now starts with:
- Feanorian Lamp (1) - permanent light source
- Horn of Blasting (1) - can shatter stone
- Fragment of Lembas (10) - elven waybread

Replaced generic Wooden Torches with thematic wizard equipment.

---

## Balance Changes

### BALANCE-001: Supply Cache Vault Nerf
**Commit**: 1608dff

The Supply Cache (N:43) was spawning 8 treasure items at depth 4 (200ft).

Changes:
- Increased depth requirement from 4 to 8 (400ft)
- Reduced good treasures from 4 to 2
- Reduced regular treasures from 4 to 2

---

## Files Modified

| File | Changes |
|------|---------|
| src/cmd4.c | Smithing system fixes (BUG-001 through BUG-006) |
| src/generate.c | Throne room generation fix (BUG-003) |
| src/files.c | Spirit rename (TYPO-002) |
| src/xtra1.c | Spirit rename (TYPO-002) |
| src/defines.h | Spirit comment update (TYPO-002) |
| lib/edit/vault.txt | Forge fixes, balance (BUG-007, BALANCE-001) |
| lib/edit/artefact.txt | Accent fixes (TYPO-001) |
| lib/edit/object.txt | Accent fixes (TYPO-001) |
| lib/edit/race.txt | Istari equipment (FEAT-001) |

---

*Generated by PRD execution: necromancer_bugfix_prd.json*
*All 13 tasks completed autonomously.*
